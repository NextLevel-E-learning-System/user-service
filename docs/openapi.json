{
  "openapi": "3.0.3",
  "info": { 
    "title": "User Service API", 
    "version": "1.1.0",
    "description": "Serviço de gerenciamento de usuários e funcionários. Permite completar o cadastro após auto-registro, gerenciar departamentos e controlar XP."
  },
  "paths": {
    "/users/v1/me": { 
      "get": { 
        "summary": "Perfil do usuário autenticado", 
        "tags": ["users"], 
        "security": [{ "bearerAuth": [] }], 
        "responses": { 
          "200": { 
            "description": "Dados do usuário",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/UserProfile" }
              }
            }
          }, 
          "401": { "description": "Token ausente ou inválido" },
          "404": { "description": "Usuário não encontrado" }
        } 
      } 
    },
    "/users/v1": { 
      "post": { 
        "summary": "Completar cadastro do usuário autenticado", 
        "description": "Permite que o usuário complete seu cadastro após o auto-registro. O ID do usuário é obtido automaticamente do token JWT (x-user-id). O registro básico já foi criado durante o auto-cadastro no auth-service, este endpoint completa os dados pessoais e profissionais. CPF não pode ser alterado após ser definido. Apenas instrutores podem alterar o email.",
        "tags": ["users"], 
        "security": [{ "bearerAuth": [] }],
        "requestBody": { 
          "required": true, 
          "content": { 
            "application/json": { 
              "schema": { "$ref": "#/components/schemas/CompleteRegistration" },
              "example": {
                "nome": "João Silva",
                "cpf": "12345678901",
                "departamento_id": "TI",
                "cargo": "Desenvolvedor"
              }
            } 
          } 
        }, 
        "responses": { 
          "200": { 
            "description": "Cadastro atualizado com sucesso",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/UserProfile" }
              }
            }
          }, 
          "400": { 
            "description": "Dados inválidos",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "examples": {
                  "validation_error": {
                    "summary": "Erro de validação",
                    "value": {
                      "error": "validation_error",
                      "details": ["CPF deve conter exatamente 11 dígitos"]
                    }
                  },
                  "cpf_cannot_change": {
                    "summary": "CPF não pode ser alterado",
                    "value": {
                      "error": "cpf_cannot_be_changed",
                      "message": "CPF não pode ser alterado após ser definido"
                    }
                  },
                  "invalid_department": {
                    "summary": "Departamento inválido",
                    "value": {
                      "error": "invalid_department",
                      "message": "Departamento não encontrado"
                    }
                  }
                }
              }
            }
          },
          "401": { "description": "Token ausente ou inválido" },
          "403": { 
            "description": "Sem permissão para alterar email",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": {
                  "error": "email_change_not_allowed",
                  "message": "Apenas instrutores podem alterar o email"
                }
              }
            }
          },
          "404": { "description": "Usuário não encontrado" },
          "409": { 
            "description": "Dados duplicados",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "examples": {
                  "cpf_exists": {
                    "summary": "CPF já existe",
                    "value": {
                      "error": "cpf_already_exists",
                      "message": "CPF já está em uso por outro usuário"
                    }
                  },
                  "email_exists": {
                    "summary": "Email já existe",
                    "value": {
                      "error": "email_already_exists",
                      "message": "Email já está em uso por outro usuário"
                    }
                  }
                }
              }
            }
          }
        } 
      } 
    },
    "/users/v1/departments": {
      "get": {
        "summary": "Listar departamentos disponíveis",
        "description": "Retorna todos os departamentos disponíveis para seleção durante o cadastro.",
        "tags": ["departments"],
        "responses": {
          "200": {
            "description": "Lista de departamentos",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/Department" }
                },
                "example": [
                  { "id": "TI", "name": "Tecnologia da Informação", "description": null },
                  { "id": "RH", "name": "Recursos Humanos", "description": null },
                  { "id": "VEN", "name": "Vendas", "description": null }
                ]
              }
            }
          }
        }
      }
    },
    "/users/v1/{id}": { 
      "get": { 
        "summary": "Obter usuário por ID", 
        "tags": ["users"], 
        "parameters": [{ 
          "name": "id", 
          "in": "path", 
          "required": true, 
          "schema": { "type": "string", "format": "uuid" },
          "description": "ID único do usuário"
        }], 
        "responses": { 
          "200": { 
            "description": "Dados do usuário",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/UserProfile" }
              }
            }
          }, 
          "404": { "description": "Usuário não encontrado" } 
        } 
      } 
    },
    "/users/v1/{id}/xp": { 
      "patch": { 
        "summary": "Alterar XP do usuário", 
        "description": "Incrementa ou decrementa o XP total do usuário.",
        "tags": ["users"], 
        "parameters": [{ 
          "name": "id", 
          "in": "path", 
          "required": true, 
          "schema": { "type": "string", "format": "uuid" },
          "description": "ID único do usuário"
        }], 
        "requestBody": { 
          "required": true, 
          "content": { 
            "application/json": { 
              "schema": { "$ref": "#/components/schemas/XpUpdate" },
              "example": { "delta": 100 }
            } 
          } 
        }, 
        "responses": { 
          "200": { 
            "description": "XP atualizado com sucesso",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": { "type": "string", "format": "uuid" },
                    "xp_total": { "type": "integer" }
                  }
                }
              }
            }
          }, 
          "404": { "description": "Usuário não encontrado" } 
        } 
      } 
    }
  },
  "components": { 
    "securitySchemes": { 
      "bearerAuth": { 
        "type": "http", 
        "scheme": "bearer", 
        "bearerFormat": "JWT" 
      } 
    },
    "schemas": {
      "UserProfile": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "cpf": { "type": "string", "nullable": true },
          "name": { "type": "string" },
          "email": { "type": "string", "format": "email" },
          "departamento_id": { "type": "string", "nullable": true },
          "cargo": { "type": "string", "nullable": true },
          "xp_total": { "type": "integer" },
          "nivel": { "type": "string" },
          "status": { "type": "string" }
        }
      },
      "CompleteRegistration": {
        "type": "object",
        "required": ["nome", "cpf", "departamento_id", "cargo"],
        "properties": {
          "nome": { 
            "type": "string", 
            "minLength": 1,
            "description": "Nome completo do funcionário"
          },
          "cpf": { 
            "type": "string", 
            "pattern": "^\\d{11}$",
            "description": "CPF com 11 dígitos (apenas números). Não pode ser alterado após ser definido."
          },
          "email": { 
            "type": "string", 
            "format": "email",
            "description": "Novo email (apenas para instrutores)"
          },
          "departamento_id": { 
            "type": "string", 
            "description": "Código do departamento (deve existir na tabela departamentos)"
          },
          "cargo": { 
            "type": "string", 
            "minLength": 1,
            "description": "Cargo/função do funcionário"
          }
        }
      },
      "Department": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "description": "Código único do departamento" },
          "name": { "type": "string", "description": "Nome do departamento" },
          "description": { "type": "string", "nullable": true, "description": "Descrição opcional do departamento" }
        }
      },
      "XpUpdate": {
        "type": "object",
        "required": ["delta"],
        "properties": {
          "delta": { 
            "type": "integer", 
            "description": "Valor a ser adicionado (positivo) ou subtraído (negativo) do XP atual"
          }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "error": { "type": "string", "description": "Código do erro" },
          "message": { "type": "string", "description": "Mensagem descritiva do erro" },
          "details": { "description": "Detalhes adicionais do erro (ex: lista de erros de validação)" }
        }
      }
    }
  }
}
